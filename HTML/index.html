<!--
Fernando Arey Duran A00397411
Karen Abarca Garcia A01323627
-->
<html>
	
    <head>
        <title> .:: Proyecto Final ::.</title> 

		<style> 
            canvas { width: 100%; height: 100% }
        </style> 

	</head>


	<body>
		
        <script type='text/javascript' src='three.min.js'></script>
        <script src="Automovil.js"></script>
        <script src="Castillo.js"></script>

		<script>
			window.addEventListener('keydown',doKeyDown,true);

			/*POSICIONES INICIALES DE LA CAMARA*/
                  var zPos = 150;
                  var xPos = -70.0;   
                  var ypos = 0.0;   
                  var camRotation = 0;

                  /*POSICIONES INICIALES DEL AUTOMOVIL*/
                  var zPosCarro = 0;
                  var xPosCarro = -150;
                  var carroRotation = 0;
                  var llantasRotation = 0;
                  var llantasRotationZ = 0;
                  var cajuelaRotation = 0;
                  var cofreRotation = 0;
                  var puertasTraserasPos = -1.5;
                  var puertasFrenteRotation = 0;
                  var puertasFondoRotation = 0;



                  /*MANEJO DE TECLAS PARA LA NAVEGACION*/
                  function doKeyDown(evt){

                        switch (evt.keyCode) {

                              /*NAVEGACION*/
                              case 38:  /* Up arrow was pressed */         
                                    var dx = 5 * Math.sin(camRotation); 
                                    var dz = 5 * Math.cos(camRotation); 
                                    zPos -= dz;
                                    xPos -= dx;
                                    break;

                              case 40:  /* Down arrow was pressed */                        
                                    var dx = 5 * Math.sin(camRotation); 
                                    var dz = 5 * Math.cos(camRotation); 
                                    zPos += dz;
                                    xPos += dx;
                                    break;

                              case 37:  /* Left arrow was pressed */                        
                                    camRotation += (5 * Math.PI) / 180;
                                    break;

                              case 39:  /* Right arrow was pressed */                        
                                    camRotation -= (5 * Math.PI) / 180;
                                    break;

                              case 87:  /* W was pressed */
                                    camera.position.y += 3;                        
                                    break;
                          
                              case 83:  /* S was pressed */
                                    camera.position.y -= 3;                        
                                    break;
                          
                              case 65:  /* A was pressed */                        
                                    var dx = 5 * Math.sin(camRotation + Math.PI / 2 ); 
                                    var dz = 5 * Math.cos(camRotation + Math.PI / 2 ); 
                                    zPos -= dz;
                                    xPos -= dx;
                                    break;
                          
                              case 68:  /* D was pressed */
                                    var dx = 5 * Math.sin(camRotation - Math.PI / 2); 
                                    var dz = 5 * Math.cos(camRotation- Math.PI / 2); 
                                    zPos -= dz;
                                    xPos -= dx;                   
                                    break;

                              case 84: /*T was pressed -> Auto avanza*/
                                    var dx = 5 * Math.sin(carroRotation - Math.PI / 2 ); 
                                    var dz = 5 * Math.cos(carroRotation - Math.PI / 2 ); 
                                    zPosCarro -= dz;
                                    xPosCarro -= dx;
                                    llantasRotation -= 0.5;
                                    llantasRotationZ = 0.0;
                                    break;

                              case 71: /*G was pressed -> Auto retrocede*/
                                    var dx = 5 * Math.sin(carroRotation + Math.PI / 2 ); 
                                    var dz = 5 * Math.cos(carroRotation + Math.PI / 2 ); 
                                    zPosCarro -= dz;
                                    xPosCarro -= dx;
                                    llantasRotation += 0.5;
                                    llantasRotationZ = 0.0;
                                    break;


                              case 72: /*H was pressed -> Auto rota a la derecha*/
                                    carroRotation -= (5 * Math.PI) / 180;
                                    if (llantasRotationZ + 0.003 < 0.4) 
                                          llantasRotationZ += 0.003;
                                    break;

                              case 70: /*F was pressed -> Auto rota a la izquierda*/
                                    carroRotation += (5 * Math.PI) / 180;

                                    if (llantasRotationZ - 0.003 > -0.4) 
                                          llantasRotationZ -= 0.003;
                                    break;

                              case 66: /*B was pressed -> Cierra cajuela*/
                                    if (cajuelaRotation + 0.03 <= 0) 
                                          cajuelaRotation += 0.03;
                                    break;



                              case 86: /*V was pressed -> Abre cajuela*/
                                    if (cajuelaRotation - 0.03 >= -1.1) 
                                          cajuelaRotation -= 0.03;
                                    break;



                              case 82: /*R was pressed -> Cierra cofre*/
                                    if (cofreRotation - 0.03 >= 0) 
                                          cofreRotation -= 0.03;
                                    break;
                                    

                              case 89: /*Y was pressed -> Abre cofre*/
                                    if (cofreRotation + 0.03 <= 1) 
                                          cofreRotation += 0.03;
                                    break;



                              case 74: /*J was pressed -> Cierra puertas*/
                                    if (puertasFrenteRotation - 0.03 >= 0) {
                                          puertasFrenteRotation -= 0.03;
                                          puertasFondoRotation += 0.03;
                                    }
                                    console.log(puertasFrenteRotation);
                                    break;

                              case 85: /*U was pressed -> Abre puertas*/
                                    if (puertasFrenteRotation + 0.03 <= 0.75) {
                                          puertasFrenteRotation += 0.03;
                                          puertasFondoRotation -= 0.03;
                                    }
                                    console.log(puertasFrenteRotation);
                                    
                                    break;

                        }//Fin switch

                  }//Fin funcion 


                  /*TRES COMPONENTES BASICOS DE LA ESCENA*/
                  var scene = new THREE.Scene();              //Escena
                  var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);  //Camara
                  var renderer = new THREE.WebGLRenderer();   //Render
      			

                  

                  /*DECLARACION Y CREACION DE GRUPOS*/
                  var grupoCarrusel = new THREE.Object3D();
                  var grupoRuedaFortuna = new THREE.Object3D();
                  var grupoRueda = new THREE.Object3D();
                  var grupoTazasLocas = new THREE.Object3D();

                  //Grupos que se clonaran para contener caballos, tazas, platos y canastas individuales
                  var grupoCaballo = new THREE.Object3D();
                  var grupoTaza = new THREE.Object3D();
                  var grupoPlato = new THREE.Object3D();
                  var grupoCanasta = new THREE.Object3D();
            


                  /*MATERIALES*/
                  var techoCarrusel = new THREE.MeshLambertMaterial({map: THREE.ImageUtils.loadTexture("img/techoCarrusel.png")});
                  var texturaTaza = new THREE.MeshLambertMaterial({map: THREE.ImageUtils.loadTexture("img/texturaTaza.jpeg")});
                  var texturaPasto = new THREE.MeshLambertMaterial({map: THREE.ImageUtils.loadTexture("img/texturaPasto.jpg"), side: THREE.DoubleSide});
                   var texturaCielo = new THREE.MeshLambertMaterial({map: THREE.ImageUtils.loadTexture("img/texturaCielo.jpg"), side: THREE.DoubleSide});

                  var material = new THREE.MeshLambertMaterial({color: 0xEEEEEE, side: THREE.DoubleSide});
                  var materialRojo = new THREE.MeshLambertMaterial({color: 0xFF3333, side: THREE.DoubleSide});
                  var materialDorado = new THREE.MeshLambertMaterial({color: 0xE49E56, side: THREE.DoubleSide});
                  var materialCafe = new THREE.MeshLambertMaterial({color: 0x994C00, side: THREE.DoubleSide});
                  var materialBlanco = new THREE.MeshLambertMaterial({color: 0xFFFFFF, side: THREE.DoubleSide});
                  var materialAzul = new THREE.MeshLambertMaterial({color: 0x0080FF, side: THREE.DoubleSide});
                  var materialMorado = new THREE.MeshLambertMaterial({color: 0xB266FF, side: THREE.DoubleSide});
                  var materialVerde = new THREE.MeshLambertMaterial({color: 0x00FF00, side: THREE.DoubleSide});
                  
                  
                  
                  
                  


            








                
                  /****CARRUSEL****/

                  /*GEOMETRIAS*/
                  //Geometrias del techo
                  var geometriaEsfera = new THREE.SphereGeometry(1,20,20);
                  var geometriaCilindroPunta = new THREE.CylinderGeometry(0.2,0.2,4,20,20,false);
                  var GeometriaCono = new THREE.CylinderGeometry(0,23,4,20,20,false);
                  var geometriaCilindroTecho = new THREE.CylinderGeometry(23,23,1,20,20,false);

                  //Geometrias del centro
                  var geometriaCilindroCentro = new THREE.CylinderGeometry(1.5,1.5,18,20,20,false);
                  var geometriaCilindroCaballos = new THREE.CylinderGeometry(0.2,0.2,18,20,20,false);

                  //Geometria de los caballos
                  var geometriaTorsoCaballo = new THREE.CubeGeometry(3, 1.5, 1.5);
                  var geometriaCuelloCaballo = new THREE.CubeGeometry(2, 1, 1.5);
                  var geometriaCabezaCaballo = new THREE.CubeGeometry(1.5, 1, 1.5);
                  var geometriaOrejaCaballo = new THREE.CylinderGeometry(0, 0.2, 0.9,20,20,false);
                  var geometriaPataCaballo = new THREE.CubeGeometry(0.5, 2, 0.5);
                  var geometriaBaseColaCaballo = new THREE.CubeGeometry(0.5, 2, 0.5);
                  var geometriaFinColaCaballo = new THREE.CubeGeometry(1, 0.5, 0.5);

                  //Geometrias base
                  var geometriaCilindroEscalon1 = new THREE.CylinderGeometry(23.6,23.6,.5,20,20);
                  var geometriaCilindroEscalon2 = new THREE.CylinderGeometry(23.8,23.8,.2,20,20);



                  /*OBJETOS DE LA ESCENA*/
                  //Techo
                  var esfera = new THREE.Mesh(geometriaEsfera,material);
                  var punta = new THREE.Mesh(geometriaCilindroPunta,material);
                  var cono = new THREE.Mesh(GeometriaCono,techoCarrusel);
                  var cilindroTecho = new THREE.Mesh(geometriaCilindroTecho,material);


                  //Centro
                  var cilindroCentro = new THREE.Mesh(geometriaCilindroCentro,materialRojo);

                  var tubosCaballos = [];
                  for (var i = 0; i < 16; i++) {
                        tubosCaballos[i] = new THREE.Mesh(geometriaCilindroCaballos,material);
                  }
                  

                  //Caballo
                  var torsoCaballo = new THREE.Mesh(geometriaTorsoCaballo,materialCafe);
                  var cuelloCaballo = new THREE.Mesh(geometriaCuelloCaballo,materialCafe);
                  var cabezaCaballo = new THREE.Mesh(geometriaCabezaCaballo,materialCafe);
                  var orejaFCaballo = new THREE.Mesh(geometriaOrejaCaballo,materialCafe);
                  var orejaACaballo = new THREE.Mesh(geometriaOrejaCaballo,materialCafe);
                  var baseColaCaballo = new THREE.Mesh(geometriaBaseColaCaballo,materialCafe);
                  var finColaCaballo = new THREE.Mesh(geometriaFinColaCaballo,materialCafe);
                  var patasCaballo = [];
                  for (var i = 0; i < 4; i++) 
                        patasCaballo[i] = new THREE.Mesh(geometriaPataCaballo,materialCafe);
                  
                  //Piso
                  var base = new THREE.Mesh(geometriaCilindroTecho,materialDorado);
                  var escalon1 = new THREE.Mesh(geometriaCilindroEscalon1,materialRojo);
                  var escalon2 = new THREE.Mesh(geometriaCilindroEscalon2,materialDorado);




                  /*POSICIONES DE OBJETOS*/
                  //Techo
                  esfera.position.y = 3;
                  punta.position.y = 0;
                  cono.position.y = -2;
                  cilindroTecho.position.y = -4.5;

                  //Piso
                  base.position.y = -23;
                  escalon1.position.y = -23;
                  escalon2.position.y = -23;

                  //Tubo Centro
                  cilindroCentro.position.y = -13.5;

                  //Tubos externos caballos 
                  var angulo = 0;
                  for (var i = 0; i < 8; i++) {
                        tubosCaballos[i].position.y = -13.5;
                        tubosCaballos[i].position.x = Math.sin(angulo) * 20;
                        tubosCaballos[i].position.z = Math.cos(angulo) * 20;
                        
                        angulo += (Math.PI * 2) / 8;
                  };

                  //Tubos internos caballos
                  var angulo = 0;
                  for (var i = 8; i < 16; i++) {
                        tubosCaballos[i].position.y = -13.5;
                        tubosCaballos[i].position.x = Math.sin(angulo + 0.392699082) * 12;
                        tubosCaballos[i].position.z = Math.cos(angulo + 0.392699082) * 12;
                        
                        angulo += (Math.PI * 2) / 8;
                  };

                  //Caballo
                  torsoCaballo.position.x = -0.5;

                  cuelloCaballo.position.x = torsoCaballo.position.x + 1.5;
                  cuelloCaballo.position.y = 0.8;
                  cuelloCaballo.position.z = torsoCaballo.position.z;
                  cuelloCaballo.rotation.z = 1.04719755; //60 grados

                  cabezaCaballo.position.x = cuelloCaballo.position.x + 0.8;
                  cabezaCaballo.position.y = cuelloCaballo.position.y + 0.8;

                  orejaACaballo.position.x = cabezaCaballo.position.x - 0.4;
                  orejaACaballo.position.y = cabezaCaballo.position.y + 0.95;
                  orejaACaballo.position.z = cabezaCaballo.position.z - 0.5;

                  orejaFCaballo.position.x = cabezaCaballo.position.x - 0.4;
                  orejaFCaballo.position.y = cabezaCaballo.position.y + 0.95;
                  orejaFCaballo.position.z = cabezaCaballo.position.z + 0.5;
                  
                  baseColaCaballo.position.x = torsoCaballo.position.x - 1.75;
                  baseColaCaballo.position.y = torsoCaballo.position.y - 1;
                  baseColaCaballo.position.z = torsoCaballo.position.z;

                  finColaCaballo.position.x = baseColaCaballo.position.x - 0.75;
                  finColaCaballo.position.y = baseColaCaballo.position.y - 0.75;
                  finColaCaballo.position.z = torsoCaballo.position.z;

                  for (var i = 0; i < 4; i++) 
                        patasCaballo[i].position.y = torsoCaballo.position.y - 1.75;
                  
                  //Patas delanteras
                  patasCaballo[0].position.z = torsoCaballo.position.z + 0.5;
                  patasCaballo[1].position.z = torsoCaballo.position.z - 0.5;
                  patasCaballo[0].position.x = torsoCaballo.position.x + 1.25;
                  patasCaballo[1].position.x = torsoCaballo.position.x + 1.25;

                  //Patas traseras
                  patasCaballo[2].position.z = torsoCaballo.position.z + 0.5;
                  patasCaballo[3].position.z = torsoCaballo.position.z - 0.5;
                  patasCaballo[2].position.x = torsoCaballo.position.x - 1.25;
                  patasCaballo[3].position.x = torsoCaballo.position.x - 1.25;

                  //Se agregan los objetos torso, cuello, cabeza, patas y cola al grupo caballo
                  grupoCaballo.add(torsoCaballo);
                  grupoCaballo.add(cuelloCaballo);
                  grupoCaballo.add(cabezaCaballo);
                  grupoCaballo.add(orejaACaballo);
                  grupoCaballo.add(orejaFCaballo);
                  grupoCaballo.add(baseColaCaballo);
                  grupoCaballo.add(finColaCaballo);
                  for (var i = 0; i < 4; i++) 
                        grupoCaballo.add(patasCaballo[i]);


                  //Clonando el grupo caballo y estableciendo su posicion
                  var angulo = 0;
                  var grupoCaballos = [];
                  for (var i = 0; i < 8; i++) {
                        grupoCaballos[i] = grupoCaballo.clone();

                        var x = Math.sin(angulo) * 20;
                        var z = Math.cos(angulo) * 20;

                        grupoCaballos[i].applyMatrix( new THREE.Matrix4().makeTranslation( x , - 11 - Math.abs(Math.sin(angulo) * 6), z));
                        grupoCaballos[i].rotation.y = angulo;

                        angulo += Math.PI * 2 / 8;

                  };

                  var angulo = 0;
                  for (var i = 8; i < 16; i++) {
                        grupoCaballos[i] = grupoCaballo.clone();

                        var x = Math.sin(angulo + 0.392699082) * 12;
                        var z = Math.cos(angulo + 0.392699082) * 12;

                        grupoCaballos[i].applyMatrix( new THREE.Matrix4().makeTranslation( x, - 11 - Math.abs(Math.sin(angulo) * 6), z));
                        grupoCaballos[i].rotation.y = angulo + 0.392699082;

                        angulo += (Math.PI * 2 / 8);

                  };


                  //Se agregan los objetos al grupo Carrusel
                  grupoCarrusel.add(esfera);
                  grupoCarrusel.add(punta);
                  grupoCarrusel.add(cono);
                  grupoCarrusel.add(cilindroTecho);
                  grupoCarrusel.add(cilindroCentro);
                  grupoCarrusel.add(base);
                  grupoCarrusel.add(escalon1);
                  grupoCarrusel.add(escalon2);
                  for (var i = 0; i < 16; i++) {
                        grupoCarrusel.add(tubosCaballos[i]);

                        grupoCarrusel.add(grupoCaballos[i]);
                  }

                  //Posicion del grupo Carrusel
                  grupoCarrusel.position.x = -40;
                  grupoCarrusel.position.z = 20;

                  //Anadiendo el carrusel a la escena
                  scene.add(grupoCarrusel);













                  /****RUEDA DE LA FORTUNA****/
                  
                  //GEOMETRIAS
                  //Base
                  var geometriaBase1 = new THREE.CubeGeometry(54, 70, 1);
                  var geometriaBase2 = new THREE.CubeGeometry(40, 56, 4);

                  //Rueda
                  var geometriaRueda = new THREE.TorusGeometry(40, 0.2, 16,100);
                  var geometriaRuedaUnion = new THREE.CylinderGeometry(0.1, 0.1, 80, 20, 20,false);
                  var geometriaUnionRuedas = new THREE.CylinderGeometry(0.1, 0.1, 5.6, 20, 20,false);

                  //Soporte
                  var geometriaSoporte = new THREE.CylinderGeometry(0.5, 2, 52, 20, 20, false);
                  var geometriaunionSoporte = new THREE.CylinderGeometry(1, 1, 10, 0, 20,false);

                  //Canasta
                  var geometriaCanasta = new THREE.CylinderGeometry(2.7, 1.5, 3, 20, 20, true,2,2);
                  var geometriaCanastaI = new THREE.CylinderGeometry(2.35, 1.15, 3, 20, 20, true, 0, Math.PI * 1.5);
                  var geometriaTechoCanasta = new THREE.CylinderGeometry(1, 2.7, 0.5, 20, 20,false);
                  var geometriaPisoCanasta = new THREE.CylinderGeometry(1.5, 1.5, 0.1, 20, 20,false);
                  var geometriaUnionTecho = new THREE.CylinderGeometry(0.1, 0.1, 2.55, 20, 20,false);
                  var geometriaUnionCanastas = new THREE.RingGeometry(2.35,2.7,50);
                  var geometriaUnionCanastasRueda = new THREE.CylinderGeometry(0.1, 0.1, 0.95, 20, 20,false);



                  //OBJETOS DE LA ESCENA
                  //Base
                  var base1 = new THREE.Mesh(geometriaBase1,materialBlanco);
                  var base2 = new THREE.Mesh(geometriaBase2,materialBlanco);

                  //Rueda
                  var rueda1 = new THREE.Mesh(geometriaRueda,materialAzul);
                  var rueda2 = new THREE.Mesh(geometriaRueda,materialAzul);

                  //Union de el centro
                  var uniones = [];
                  for(var i = 0; i < 20; i++)
                        uniones[i] = new THREE.Mesh(geometriaRuedaUnion,materialRojo);                  

                  //Union entre ruedas para soportar canastas
                  var unionRuedas = [];
                  for(var i = 0; i < 20; i++)
                        unionRuedas[i] = new THREE.Mesh(geometriaUnionRuedas,material);

                  //Soportes
                  var soporte1 = new THREE.Mesh(geometriaSoporte,materialBlanco);
                  var soporte2 = new THREE.Mesh(geometriaSoporte,materialBlanco);
                  var soporte3 = new THREE.Mesh(geometriaSoporte,materialBlanco);
                  var soporte4 = new THREE.Mesh(geometriaSoporte,materialBlanco);

                  var unionSoporte = new THREE.Mesh(geometriaunionSoporte,materialBlanco);

                  //Canastas
                  canasta = new THREE.Mesh(geometriaCanasta, materialDorado);
                  canastaI = new THREE.Mesh(geometriaCanastaI, materialBlanco);
                  techo = new THREE.Mesh(geometriaTechoCanasta, materialDorado);
                  piso = new THREE.Mesh(geometriaPisoCanasta, materialDorado);
                  unionTecho = new THREE.Mesh(geometriaUnionTecho, materialDorado);
                  unionCanasta = new THREE.Mesh(geometriaUnionCanastas, materialDorado);
                  unionCanastaRueda = new THREE.Mesh(geometriaUnionCanastasRueda, materialDorado);





                  //POSICIONES DE LOS OBJETOS

                  //Centro de la rueda
                  grupoRueda.applyMatrix( new THREE.Matrix4().makeTranslation( 0, 28, 0) );

                  //Base
                  base1.position.y = -23;
                  base1.rotation.x =Math.PI/2;
                  base1.rotation.z = Math.PI/2;

                  base2.position.y= -22;
                  base2.rotation.x = Math.PI/2;
                  base2.rotation.z = Math.PI/2;

                  //Rueda
                  rueda1.position.z = 2.8;
                  rueda2.position.z = -2.8;

                  soporte1.position.y = 3.75;
                  soporte1.position.z = 6;
                  soporte1.rotation.x = -0.08;
                  soporte1.position.x = 10;
                  soporte1.rotation.z = -5.9;

                  soporte2.position.y = 3.75;
                  soporte2.position.z = -6;
                  soporte2.rotation.x = 0.08;
                  soporte2.position.x = 10;
                  soporte2.rotation.z = -5.9;

                  soporte3.position.y = 3.75;
                  soporte3.position.z = 6;
                  soporte3.rotation.x = -0.08;
                  soporte3.position.x = -10;
                  soporte3.rotation.z = 5.9;

                  soporte4.position.y = 3.75;
                  soporte4.position.z = -6;
                  soporte4.rotation.x = 0.08;
                  soporte4.position.x = -10;
                  soporte4.rotation.z = 5.9;

                  unionSoporte.rotation.x = Math.PI/2;
                  unionSoporte.position.y= 27.9;
                  
                  var i;
                  var angulo = 0;
                  for(var i = 0; i < 10; i++){
                        uniones[i].position.z = 2.8;
                        uniones[i].rotation.z = angulo;
                        angulo += Math.PI/10;
                  }
                  angulo = 0;
                  for(var i = 10; i < 20; i++){
                        uniones[i].position.z = -2.8;
                        uniones[i].rotation.z = angulo;
                        angulo += Math.PI/10;
                  }

                  angulo = 0;
                  for (var i = 0; i < 20; i++) {
                        unionRuedas[i].position.x = Math.cos(angulo) * 40;
                        unionRuedas[i].position.y = Math.sin(angulo) * 40;
                        unionRuedas[i].rotation.x = Math.PI / 2;

                        angulo += Math.PI/10;
                  }


                  //Posicion de las canastas
                  canasta.position.y = - 5.5;
                  canastaI.position.y = - 5.5;

                  unionCanasta.position.y = - 4;
                  unionCanasta.rotation.x = Math.PI / 2;

                  techo.position.y = - 1.2;
                  piso.position.y = - 7;

                  unionTecho.position.y = - 2.725;
                  unionTecho.position.z = - 2.55;

                  unionCanastaRueda.position.y = -0.475;
                  

                  
                  //AGREGANDO OBJETOS AL GRUPO CANASTA
                  grupoCanasta.add(canasta);
                  grupoCanasta.add(canastaI);
                  grupoCanasta.add(unionCanasta);
                  grupoCanasta.add(techo);
                  grupoCanasta.add(piso);
                  grupoCanasta.add(unionTecho);
                  grupoCanasta.add(unionCanastaRueda);

                  
                  //Clonando el grupo canasta y estableciendo sus posiciones
                  var angulo = 0;
                  var grupoCanastas = [];
                  for (var i = 0; i < 20; i++) {
                        grupoCanastas[i] = grupoCanasta.clone();

                        grupoCanastas[i].applyMatrix( new THREE.Matrix4().makeTranslation( Math.sin(angulo) * 40 , Math.cos(angulo) * 40, 0));

                        angulo += Math.PI / 10;

                        grupoRueda.add(grupoCanastas[i]);
                  };


                  //AGREGANDO OBJETOS AL GRUPO RUEDA                  
                  grupoRueda.add(rueda1);
                  grupoRueda.add(rueda2);
                  for(var i = 0; i<32; i++){
                        grupoRueda.add(uniones[i]);
                  }
                  for(var i = 0; i < 20; i++)
                        grupoRueda.add(unionRuedas[i]);


                  //AGREGANDO OBJETOS AL GRUPO RUEDA FORTUNA
                  grupoRuedaFortuna.add(grupoRueda);
                  grupoRuedaFortuna.add(base1);
                  grupoRuedaFortuna.add(base2);
                  grupoRuedaFortuna.add(soporte1);
                  grupoRuedaFortuna.add(soporte2);
                  grupoRuedaFortuna.add(soporte3);
                  grupoRuedaFortuna.add(soporte4);
                  grupoRuedaFortuna.add(unionSoporte);


                  grupoRuedaFortuna.position.x = 35;
                  grupoRuedaFortuna.position.z = -35;
                  grupoRuedaFortuna.position.y = 1;


                  scene.add(grupoRuedaFortuna);















                  /*TAZAS LOCAS*/

                  //GEOMETRIAS
                  var geometriaCilindroBaseTaza = new THREE.CylinderGeometry(22,22,1,20,20,false);
                  var geometriaCilindroE1 = new THREE.CylinderGeometry(22.3,22.3,.5,20,20);
                  var geometriaCilindroE2 = new THREE.CylinderGeometry(22.5,22.5,.2,20,20);
                  
                  var geometriaPlato = new THREE.CylinderGeometry(2,1,0.5,20,20, true);
                  var geometriaBasePlato = new THREE.CylinderGeometry(1,1,0.1,20,20, false);

                  var geometriaTaza = new THREE.CylinderGeometry(2,1,2,20,20, true);
                  var geometriaTaza2 = new THREE.CylinderGeometry(1.9,0.9,2,20,20, true);
                  var geometriaUnionTaza = new THREE.RingGeometry(1.9,2,32);
                  var geometriaAza = new THREE.TorusGeometry( 0.6, 0.2, 16, 100, Math.PI + 0.3);

                  var geometriaEsferaCentro = new THREE.SphereGeometry(3,20,20);



                  
                  //OBJETOS DE LA ESCENA
                  var baseTazas = new THREE.Mesh(geometriaCilindroBaseTaza,materialDorado);
                  var escalon1Tazas = new THREE.Mesh(geometriaCilindroE1,materialMorado);
                  var escalon2Tazas = new THREE.Mesh(geometriaCilindroE2,materialDorado);

                  var plato = new THREE.Mesh(geometriaPlato,material);
                  var basePlato = new THREE.Mesh(geometriaBasePlato,material);

                  var taza = new THREE.Mesh(geometriaTaza,texturaTaza);
                  var tazaI = new THREE.Mesh(geometriaTaza2,materialBlanco);
                  var unionTaza = new THREE.Mesh(geometriaUnionTaza,texturaTaza);
                  var aza = new THREE.Mesh( geometriaAza, material);

                  var centro = new THREE.Mesh(geometriaCilindroCentro, materialBlanco)
                  var esferaCentro = new THREE.Mesh(geometriaEsferaCentro, materialMorado)



                  //POSICIONES DE LOS OBJETOS

                  centro.position.y = 9;
                  esferaCentro.position.y = 18;

                  plato.position.set(0, 0.8, 0);
                  basePlato.position.set(0, 0.5, 0);

                  taza.position.set(0, 1.7, 0);
                  tazaI.position.set(0, 1.7, 0);

                  aza.position.set(1.61, 1.8, 0);
                  aza.rotation.z = -Math.PI / 4 - 1.4;

                  unionTaza.position.set(0,2.7,0);
                  unionTaza.rotation.x = -Math.PI / 2;


                  //ANADIENDO OBJETOS AL GRUPO TAZA
                  grupoTaza.add(plato);
                  grupoTaza.add(basePlato);
                  grupoTaza.add(taza);
                  grupoTaza.add(tazaI);
                  grupoTaza.add(unionTaza);
                  grupoTaza.add(aza);


                  //CLONANDO EL GRUPO TAZA Y ESTABLECIENDO SU CENTRO
                  var angulo = 0;
                  var grupoTazas = [];
                  for (var i = 0; i < 8 ; i++) {
                        grupoTazas[i] = grupoTaza.clone();

                        grupoTazas[i].applyMatrix( new THREE.Matrix4().makeTranslation(Math.sin(angulo) * 16, 0, Math.cos(angulo) * 16) );

                        angulo += Math.PI / 4;
                  };

                  var angulo = 0;
                  for (var i = 8; i < 16 ; i++) {

                        grupoTazas[i] = grupoTaza.clone();

                        grupoTazas[i].applyMatrix(new THREE.Matrix4().makeTranslation(Math.sin(angulo + 0.392699082) * 10, 0, Math.cos(angulo + 0.392699082) * 10) );      
                        angulo += Math.PI / 4;
                  };


                  

                  //Anadiendo objetos al grupo general de las tazas locas
      	      grupoTazasLocas.add(baseTazas);  
                  grupoTazasLocas.add(escalon1Tazas);
                  grupoTazasLocas.add(escalon2Tazas);
                  grupoTazasLocas.add(centro);
                  grupoTazasLocas.add(esferaCentro);


                  for(i = 0; i < 16; i++)
                        grupoTazasLocas.add(grupoTazas[i]);


                  //Posicion del grupo
                  grupoTazasLocas.position.x = 40;
                  grupoTazasLocas.position.z = 40;
                  grupoTazasLocas.position.y = -23;


                  //Agregando el grupo a la escena
                  scene.add(grupoTazasLocas); 





                  /*CARRO*/
                  scene.add(grupoCarro);
                  puertaTraseraFrente.applyMatrix( new THREE.Matrix4().makeTranslation( -10.5, 0,0));






                  /*CASTILLO*/
                  scene.add(castillo);
                  castillo.position.set(-200,0,-100);








                  /*CREANDO EL PASTO*/
                  var geometriaPisoFeria = new THREE.PlaneGeometry(2000,2000);
                  var pisoFeria = new THREE.Mesh(geometriaPisoFeria,materialVerde);
                  pisoFeria.rotation.x = Math.PI/-2;
                  pisoFeria.position.y= -23.6;
                  scene.add(pisoFeria);


                  /*CREANDO EL CIELO*/
                  var geometriaCielo = new THREE.SphereGeometry(500,200,200);
                  var cieloFeria = new THREE.Mesh(geometriaCielo,texturaCielo);

                  scene.add(cieloFeria);










                  /*CREANDO LUCES*/
                  var pointLight = new THREE.PointLight( 0xFFFFFF );
                  var pointLight2 = new THREE.PointLight( 0xFFFFFF );
                  var pointLight3 = new THREE.PointLight( 0xFFFFFF );
                  var pointLight4 = new THREE.PointLight( 0xFFFFFF );
                  var pointLight5 = new THREE.PointLight( 0xFFFFFF );

                  pointLight.position.x = 0;
                  pointLight.position.y = 10;
                  pointLight.position.z = 00;

                  scene.add(pointLight);
                  

                  pointLight2.position.x = 10;
                  pointLight2.position.y = -50;
                  pointLight2.position.z = -130;

                  scene.add(pointLight2);


                  pointLight3.position.x = 0;
                  pointLight3.position.y = 0;
                  pointLight3.position.z = 130;
                  scene.add(pointLight3);

                  scene.add( new THREE.AmbientLight( 0x212223));

                  var light = new THREE.DirectionalLight(0xffffff, 0.5);
                  //light.position.z = 0;
                  //light.position.y = 100;
                  //light.position.x = 100;

                  var lightRueda = new THREE.DirectionalLight(0xffffff, 0);
                  lightRueda.position.z = 200;
                  lightRueda.position.y = 100;
                  lightRueda.position.x = 200;

                  //scene.add(light);
                  scene.add(lightRueda);

                  
                  renderer.shadowMapEnabled = true;
                  renderer.shadowMapSoft = false;

                  renderer.shadowCameraNear = 250;
                  renderer.shadowCameraFar = camera.far;
                  renderer.shadowCameraFov = 500;

                  renderer.shadowMapBias = 0.0039;
                  renderer.shadowMapDarkness = 0.5;
                  renderer.shadowMapWidth = 1024;
                  renderer.shadowMapHeight = 1024;

                  //light.castShadow = true;
                  lightRueda.castShadow = true;
                  
                  

                  //Carro
                  piso.castShadow = true;
                  llantaDelanteraFrente.castShadow = true;
                  llantaDelanteraFondo.castShadow = true;
                  llantaTraseraFrente.castShadow = true;
                  llantaTraseraFondo.castShadow = true;
                  grupoCarro.castShadow = true;


                  //Rueda
                  soporte1.castShadow = true;
                  soporte2.castShadow = true;
                  soporte3.castShadow = true;
                  soporte4.castShadow = true;
                  rueda1.castShadow = true;
                  rueda2.castShadow = true;
                  canasta.castShadow = true;
                  grupoRueda.castShadow = true;

                  base2.receiveShadow = true;
                  base1.receiveShadow = true;


                  //Carrusel
                  cilindroTecho.castShadow = true;
                  cilindroCentro.castShadow = true;
                  esfera.castShadow = true;
                  punta.castShadow = true;
                  cono.castShadow = true;
                  tubosCaballos.castShadow = true;
                  torsoCaballo.castShadow = true;
                  cuelloCaballo.castShadow = true;
                  for(i = 0; i < 20; i++)
                        grupoCanastas[i].castShadow = true;
                  for(i = 0; i < 16; i++){
                        grupoCaballos[i].castShadow = true;
                        grupoTazas[i].castShadow = true;
                        grupoPlato.castShadow = true;
                  }
                  base.receiveShadow = true;
                  escalon2.receiveShadow = true;
                  escalon1.receiveShadow = true;


                  //Tazas
                  centro.castShadow = true;
                  esferaCentro.castShadow = true;

                  baseTazas.receiveShadow = true;
                  escalon1Tazas.receiveShadow = true;
                  escalon2Tazas.receiveShadow = true;


                  //Castillo
                  castillo.castShadow = true;
                  cilindro1Piso.castShadow = true;
                  techo1Piso.castShadow = true;
                  baseTorre1.castShadow = true;
                  conoTorre1.castShadow = true;

                  cilindro2Piso.castShadow = true;
                  techo2Piso.castShadow = true;


                  pisoFeria.receiveShadow = true;
                  







                  /*RENDER*/
                  renderer.setClearColor(0x000000, 1);
                  //tamaño del render
                  renderer.setSize(window.innerWidth, window.innerHeight); 
                  //envio el render al html
                  document.body.appendChild(renderer.domElement); 
                  var render = function () { //creo la variable render y le asigno una funcion 
      	            requestAnimationFrame(render);  // pido el render
                        camera.position.z = zPos;
                        camera.position.x = xPos; 
                        camera.rotation.y = camRotation;

                        //ROTACION DEL CARRUSEL
                        grupoCarrusel.rotation.y += 0.01;

                        //Movimiento de los caballos
                        var angulo = [];
                        var rotacion = 0;
                        for(i = 0; i < 8; i++){
                              var angulo = Math.sin(grupoCaballos[i].rotation.y + grupoCarrusel.rotation.y);
                              grupoCaballos[i].position.y =  - 11 - Math.abs(angulo * 6);
                        }

                        for(i = 8; i < 16; i++){
                              var angulo = Math.sin(grupoCaballos[i].rotation.y + grupoCarrusel.rotation.y);
                              grupoCaballos[i].position.y =  - 11 - Math.abs(angulo * 6);
                        }



                        //ROTACION DE LA RUEDA
                        grupoRueda.rotation.z += 0.003;

                        //Rotacion individual de cada canasta
                        for(i = 0; i < 20; i++)
                              grupoCanastas[i].rotation.z -=0.003;



                        //ROTACION DE LAS TAZAS LOCAS

                        //rotacion individual de cada taza
                        for(i = 0; i < 16; i++)
                              grupoTazas[i].rotation.y +=0.07;
                        
                        //rotacion de la base
                        grupoTazasLocas.rotation.y -= 0.02;




                        /*MOVIMIENTO DEL CARRO*/
                        grupoCarro.position.x = xPosCarro;
                        grupoCarro.position.z = zPosCarro;
                        llantaDelanteraFrente.rotation.y = llantasRotation;
                        llantaDelanteraFrente.rotation.z =  llantasRotationZ;
                        llantaTraseraFrente.rotation.y = llantasRotation;
                        llantaTraseraFrente.rotation.z = llantasRotationZ;
                        llantaDelanteraFondo.rotation.y = llantasRotation;
                        llantaDelanteraFondo.rotation.z = llantasRotationZ;
                        llantaTraseraFondo.rotation.y = llantasRotation;
                        llantaTraseraFondo.rotation.z = llantasRotationZ;


                        //Carro
                        grupoCarro.position.y = -13;
                        grupoCarro.position.z = 95;
                        grupoCarro.rotation.y = carroRotation;

                        //Cajuela
                        cajuela.rotation.z = cajuelaRotation;

                        //Cofre
                        cofre.rotation.z = cofreRotation;
                        cofre.position.y = 1;

                        //Puertas
                        puertaTraseraFrente.rotation.y = puertasFrenteRotation;
                        puertaTraseraFrente.position.x = -2;

                        puertaDelanteraFrente.rotation.y = puertasFrenteRotation;
                        puertaDelanteraFrente.position.x = 6;

                        puertaTraseraFondo.rotation.y = puertasFondoRotation;
                        puertaTraseraFondo.position.x = -2;
                        puertaTraseraFondo.position.z = -9.5;

                        puertaDelanteraFondo.rotation.y = puertasFondoRotation;
                        puertaDelanteraFondo.position.x = 6;
                        puertaDelanteraFondo.position.z = -9.5;

                        renderer.render(scene, camera);     //actualiza la escena y camara
                  }; 
                  render();     
		</script>
	</body>
</html>